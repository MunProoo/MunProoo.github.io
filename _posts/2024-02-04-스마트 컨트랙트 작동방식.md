---
title: 📝 스마트 컨트랙트 작동 방식
date : 2024-02-04 19:00
category : [Study, BlockChain]
tags : [go,smart contract]
---

[저번 게시물]({% post_url 2024-02-04-smart contract %})에서 스마트 컨트랙트의 개념과 등장 배경, 장점을 알아보았다. 이어 **스마트 컨트랙트 작동 방식과 활용 사례**를 알아보자.


## 스마트 컨트랙트 작동 방식
스마트 컨트랙트는 어떻게 작동할까? 스마트 컨트랙트를 구현한 가장 대표적인 블록체인인 이더리움을 기준으로 알아보자. 

예를 들어, 코드스테이츠의 네트워킹 행사에 참여하는 모든 인원에게 CozNFT를 하나씩 나눠준다고 가정하자.   

### 스마트 컨트랙트 작성 및 배포
스마트 컨트랙트를 사용하기 위해서는 먼저 스마트 컨트랙트를 블록체인 네트워크 상에 공유해야 한다.   

**1. 컨트랙트 작성**
코드스테이츠에서는 먼저 NFT 콜렉션을 에어드랍하는 컨트랙트를 작성한다.
<br>
이더리움에서는 솔리디티(Solidity)라는 프로그래밍 언어로 스마트 컨트랙트를 작성한다. 다음과 같이 CozNFT.sol파일을 생성해 컨트랙트 코드를 작성한다.   

```
// CozNFT.sol
contract CozNFT is ERC721 {
    mapping(uint256 => address) private _owners;
    mapping(address => uint256) private _balances;

    function transferFrom(address from, uint256 to, uint256 tokenId) external {
        require(ownerOf(tokenId) == from , "Error: transfer from incorrect owner");
        require(to != address(0), "Error: transfer to the zero address");

        _balances[from] -= 1;
        _balances[to] += 1;
        _owners[tokenId] = to;
    }
}
```   

함수 transferFrom은 NFT 콜렉션을 전송하며, 전송 조건이 맞는지 확인한 후, 조건이 올바르게 만족되었다면 NFT 전송을 실행한다.    

- require구문을 통해 해당 함수를 코드스테이츠에서 실행한 것이 맞는지, 올바른 주소로 전송하는 것인지 확인한다. 
- 이후 상태변수 _balances와 _owners를 업데이트하여 NFT를 전송한다.

<br>

**2. 컴파일**

작성한 컨트랙트는 이더리움 노드의 **EVM(Etherium Virtual Machine)**이 실행한다. EVM은 **이더리움 네트워크 노드들이 가지고 있는 가상의 실행환경**으로, 컨트랙트 함수를 호출하여 그 결과를 확인할 수 있다.   

EVM이 이해할 수 있게 작성한 CozNFT.sol 을 `바이트코드(byteCode)`로 컴파일한다.  
바이트코드 형태만으로는 이 컨트랙트에 어떤 함수가 있는지 알기 어렵기 때문에 **ABI(Application Binary Interface)**도 함께 생성한다. ABI는 이 컨트랙트에 어떤 함수가 있는지, 무슨 일을 하는 함수인지 등을 적어둔 인터페이스 객체의 지합이다.
<br>   

**3. 브로드캐스팅**   
컴파일된 컨트랙트를 이더리움 네트워크 상에 브로드캐스팅한다. 그리고 컨트랙트를 배포하는 트랜잭션을 생성해 이더리움 네트워크에 전파한다.   

이때 Geth나 Parity와 같은 이더리움 클라이언트를 사용해 직접 배포하거나, 메타마스크, Infura같이 이더리움 네트워크에 접근할 수 있는 API를 제공하는 서비스를 사용해도 된다.   

![](/assets/img/YY-MM/2024-02-04-20-11-19.png)   

![](/assets/img/YY-MM/2024-02-04-20-11-38.png)
<br>   

**4. 컨트랙트 배포**   
브로드캐스팅한 컨트랙트 배포 트랜잭션을 네트워크의 다른 채굴 블록이 자신의 블록에 담아 해당 블록이 배포되면, 블록체인에 CozNFT.sol 컨트랙트가 배포된다.   

### 스마트 컨트랙트 사용 
이제, 행사에 참가자가 오면 작성한 CozNFT.sol에 있는 transferFrom 함수를 실행해 해당 참가자에게 NFT를 지급해주어야 한다. 이는 아래와 같이 동작한다.   

**1. 함수 실행 트랜잭션 생성**   
CozNFT.sol의 transferFrom 함수를 실행한다는 트랜잭션을 생성한다.   
이때, 특정 컨트랙트의 함수를 실행하기 위해서는 컨트랙트의 주소값과 컨트랙트의 ABI를 알아야 한다.   

![](/assets/img/YY-MM/2024-02-04-20-16-16.png)   
<br>   

**2. 브로드캐스팅**   
새로운 트랜잭션을 이더리움 네트워크에 브로드캐스팅한다.   
![](/assets/img/YY-MM/2024-02-04-20-17-20.png)   
<br>   

**3. transferFrom 실행**   
채굴 노드는 트랜잭션에 적혀있는대로 transferFrom을 실행한다. 이 때, CozNFT 컨트랙트는 바이트 코드 형태이므로, 채굴 노드는 자신의 EVM에서 컨트랙트 코드를 실행할 수 있다.   
<br>   

**4. 트랜잭션 추가**   
EVM에서 컨트랙트 코드를 실행한 결과에 문제가 없으면, 채굴 노드는 자신이 만들려는 새 블록에 트랜잭션을 추가한다.   
<br>   

**5. 노드 전파**  
트랜잭션이 담긴 블록이 브로드캐스팅되어 네트워크 내 모든 노드에게 전파된다. 각 노드는 블록과 블록에 든 트랜잭션이 유효한지 검증하고, 유효하다면 자신의 체인에 해당 블록을 추가합니다.   


## 스마트 컨트랙트 활용 사례
**실생활에서 스마트 컨트랙트는 어떻게 적용**되고 있을까?   
<br>   

### 🏦 탈중앙화 금융(DeFi)   
블록체인 스마트 컨트랙트의 등장으로 신뢰할 수 있는 제3자 없이도 블록체인 네트워크 프로토콜 자체의 신뢰성을 기반으로 제3자 없이 직접 거래를 할 수 있게 되었다.   

이렇게 거래소, 자산관리, 대출과 같은 **전통적인 금융 서비스를 탈중앙화된 형태로 바꾸고 스마트 컨트랙트를 통해 새로운 형태의 금융 서비스를 만드는 것을 DeFi(Decentralized Finance)**라고 부른다.  

DeFi에는 다양한 종류가 있으며, 대표적으로는 아래와 같은 서비스들이 제공되고 있다.   

- Aave : 무허가형 대출 서비스   
- UniSwap : 탈중앙화된 형태의 토큰 거래소   
- Compound Finance : 담보대출 서비스   

### 🎮 게임   
대표적인 블록체인 스마트 컨트랙트 기반 게임에는 **크립토키티(CryptoKitties)**가 있다.   

크립토키티는 고양이 캐릭터를 교배하고 육성하여 전투를 치르는 수집형 게임이다. 사용자는 최대한 좋은 고양이 캐릭터를 육성해야 하는데, **이때 고양이 캐릭터는 단순히 데이터가 아니라 블록체인 상의 스마트 컨트랙트를 통해 등록된 NFT** 형태다.   

따라서 사용자는 NFT를 게임 외부에서도 사고 팔 수 있으며, 언제 어디서든 자신이 보유한 고양이 NFT에 대한 소유권을 증명할 수 있다.  

다음 포스팅에선 블록체인 스마트 컨트랙트가 가진 한계와 사건에 대해 알아보자.   

[출처 : 코드스테이츠](https://www.codestates.com/blog/content/%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8-%EC%8A%A4%EB%A7%88%ED%8A%B8%EC%BB%A8%ED%8A%B8%EB%9E%99%ED%8A%B8-%EC%9E%91%EB%8F%99%EB%B0%A9%EC%8B%9D-%ED%99%9C%EC%9A%A9%EC%82%AC%EB%A1%80) 


