---
title: ğŸ¤” í´ë¼ìš°ë“œ ì„œë²„ì— ë°°í¬
date : 2024-01-24 23:00
category : [Study, Projects]
tags : [tomcat, nginx, deploy]
---

# ê°œìš”
ì´ì „ í”„ë¡œì íŠ¸ë“¤ì„ ë°°í¬í•˜ë©° ê³¼ì •ì„ ê¸°ë¡í•˜ë ¤ í•œë‹¤.   

## ğŸ‘‰Spring Project (ì‡¼í•‘ëª°)   
### WAR íŒŒì¼ë¡œ ë¹Œë“œ   
- Eclipseë¼ë©´ Exportë¥¼ WARë¡œ, STSë¼ë©´ í”„ë¡œì íŠ¸ ìš°í´ë¦­ -> Run as -> Maven Clean, Maven Install   

### í´ë¼ìš°ë“œ ì„œë²„ì— í†°ìº£ì„ ì„¤ì¹˜   
ë‚˜ëŠ” vultrì„ í†µí•´ì„œ í´ë¼ìš°ë“œ ì»´í“¨íŒ…ì„ í–ˆë‹¤. OSëŠ” CentOS8ë¡œ ì •í•˜ì˜€ë‹¤.   

1. JAVA ì„¤ì¹˜
ê¸°ë³¸ìœ¼ë¡œ openJDK 1.8.0ì´ ì„¤ì¹˜ë˜ì–´ ìˆì—ˆë‹¤.
í•˜ì§€ë§Œ JAVA_HOMEì´ ì¡í˜€ ìˆì§€ ì•Šì•„ì„œ ì¡ì•„ì¤˜ì•¼ í•œë‹¤.
```
export JAVA_HOME=/usr/lib/jvm/jre-openjdk
```
2. TOMCAT ì„¤ì¹˜
ì„¤ì¹˜ ê²½ë¡œëŠ” /opt/apach_ë²„ì „ ìœ¼ë¡œ í•œë‹¤.
```
cd /opt
sudo wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.85/bin/apache-tomcat-9.0.85.tar.gz
sudo tar -zxvf apach-tomcat-9.0.85.tar.gz
```   

rootë¡œ í†°ìº£ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë©´ ë³´ì•ˆ ìœ„í—˜ì´ ìˆë‹¤. ì‚¬ìš©ìë¥¼ ìƒì„±í•´ì„œ ì‹¤í–‰í•˜ë„ë¡ í•˜ì.  
```
sudo useradd -m -U -d /opt/tomcat -s /bin/false tomcat
```

í†°ìº£ ë””ë ‰í† ë¦¬ì˜ ì†Œìœ ìì™€ ê¶Œí•œ ì„¤ì •
```
sudo chown -R tomcat: /opt/apache-tomcat-9.0.85
```

í†°ìº£ ì„œë¹„ìŠ¤ ë“±ë¡
```
sudo vi /etc/systemd/system/tomcat.service
```

í†°ìº£ ì„œë¹„ìŠ¤ ë‚´ìš©
```
[Unit]
Description=Apache Tomcat 9.0 Web Application Container
After=syslog.target network.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/lib/jvm/jre-openjdk
Environment=CATALINA_PID=/opt/apache-tomcat-9.0.85/temp/tomcat.pid
Environment=CATALINA_HOME=/opt/apache-tomcat-9.0.85
Environment=CATALINA_BASE=/opt/apache-tomcat-9.0.85
Environment='CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC'
Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'

ExecStart=/opt/apache-tomcat-9.0.85/bin/startup.sh
ExecStop=/opt/apache-tomcat-9.0.85/bin/shutdown.sh

User=tomcat
Group=tomcat
UMask=0007
RestartSec=10
Restart=always

[Install]
WantedBy=multi-user.target

```   

í†°ìº£ ì„œë¹„ìŠ¤ ë“±ë¡ ë° ì‹œì‘
```
sudo systemctl daemon-reload
sudo systemctl start tomcat
sudo systemctl enable tomcat

```

ë°©í™”ë²½ ì„¤ì • 
``` bash
sudo firewall-cmd --zone=public --permanent --add-port=8080/tcp
sudo firewall-cmd --reload

```

3. WAR íŒŒì¼ ì „ì†¡
scpë¥¼ í†µí•´ì„œ ë¡œì»¬ì˜ waríŒŒì¼ì„ ì „ì†¡í–ˆë‹¤.
``` bash
scp myMusinsa.war root@158.247.252.248:/opt/apach-tomcat-9.0.85/webapps
```

server.xmlì„ ìˆ˜ì •í•˜ì—¬ ë‚´ waríŒŒì¼ì„ ë³´ë„ë¡ í•œë‹¤.
``` bash
// tomcat root ë””ë ‰í† ë¦¬ì—ì„œ.
vi conf/server.xml

<Host name="localhost"  appBase="webapps"
            unpackWARs="true" autoDeploy="true">
        <Context path="/" docBase="myMusinsa" reloadable="false"> </Context>
```
Host íƒœê·¸ì— Context íƒœê·¸ ì…ë ¥. 


4. MariaDB ì„¤ì¹˜
MariaDB ì„¤ì¹˜ repo ë‹¤ìš´ë¡œë“œ
``` bash
wget https://downloads.mariadb.com/MariaDB/mariadb_repo_setup
```

ë‹¤ìš´ë¡œë“œë°›ì€ íŒŒì¼ ì‹¤í–‰ê°€ëŠ¥í•˜ë„ë¡ and ì‹¤í–‰
ì¤‘ê°„ì— ë²„ì „ í™•ì¸ í›„ ë™ì˜í•˜ë©´ y
``` 
chmod 777 mariadb_repo_setup
./mariadb_repo_setup
dnf install MariaDB-server MariaDB-client MariaDB-common
```     

ì„œë¹„ìŠ¤ ì¬ì‹œì‘, í™œì„±í™”, í™•ì¸
```
systemctl restart mariadb
systemctl enable mariadb
systemctl status mariadb
``` 

* mariadb root ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
```
mariadb -uroot 
ALTER USER 'root'@'localhost' IDENTIFIED BY 'ìƒˆë¡œìš´_ë¹„ë°€ë²ˆí˜¸';
FLUSH PRIVILEGES;
exit;
```
* mariadb sqlíŒŒì¼ ì‹¤í–‰
```
mysql -u username -pë¹„ë°€ë²ˆí˜¸ dbname < filename.sql
```
### Trouble shooting
1. java.lang.NoClassDefFoundError
ì˜ì¡´ì„± ë¬¸ì œ í˜¹ì€ ë²„ì „ í˜¸í™˜ì˜ ë¬¸ì œê°€ ì›ì¸ì´ë‹¤.   
pom.xmlì—ì„œ í˜¸í™˜ì´ ì•ˆë˜ëŠ” ë²„ì „ì„ ê³ ì¹˜ê³ , ë¶€ì¡±í•œ ì˜ì¡´ì„±ì´ ìˆë‹¤ë©´ ì¶”ê°€í•´ì¤€ë‹¤.    
<br>
2. ckeditorë¥¼ ì´ìš©í•´ ì„œë²„ë¡œ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ì•ˆë³´ì´ëŠ” ë¬¸ì œ  
ë””ë²„ê¹… ì‹œì—ëŠ” stsì˜ workspace ê²½ë¡œì—ì„œ `.metadata/.plugins/org.eclipse.wst.server.core/tmp1/wtpwebapps/cjs2108_mjyProject/resources/data` ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡ê³  ê·¸ í•˜ìœ„ì—ì„œ ìƒí’ˆ, ê²Œì‹œíŒ, ê³µì§€ì‚¬í•­ì— ë“¤ì–´ê°€ëŠ” ì´ë¯¸ì§€ê°€ ê°ê°ì˜ ë””ë ‰í† ë¦¬ë¥¼ í–¥í•´ ê°€ë„ë¡ í•˜ì˜€ë‹¤.   
- ê²Œì‹œë¬¼ ë“±ë¡ ì‹œ : ì´ë¯¸ì§€ê°€ í•´ë‹¹í•˜ëŠ” ë””ë ‰í† ë¦¬ì— ì €ì¥
- ê²Œì‹œë¬¼ ìˆ˜ì • ì‹œ : ì´ë¯¸ì§€ë¥¼ ì ì‹œ ì§€ì •ëœ ì„ì‹œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™   
- ê²Œì‹œë¬¼ ìˆ˜ì • ì™„ë£Œ ì‹œ : ì´ë¯¸ì§€ ì›ë³µ  

ì´ë¯¸ì§€ ì´ë¦„ë§Œì„ ë”°ë¡œ ë¶„ë¦¬í•´ì•¼í•˜ëŠ” ì‘ì—…ë“¤ì´ ë§ì•˜ëŠ”ë°, ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ ì´ë¦„ì´ ì‹œì‘í•˜ëŠ” indexë¥¼ hardcoding (ì–´ì§¸ì„œ.. ì™œ...ê·¸ë¬ì„ê¹Œ) ìœ¼ë¡œ ì¡ì•„ë†“ì•˜ê³  ì´ ë¶€ë¶„ì´ ë¬¸ì œê°€ ë˜ì—ˆë‹¤.   
ë°°í¬ì‹œì—ëŠ” tomcatì— ì˜¬ë¦° waríŒŒì¼ì˜ ë””ë ‰í† ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ê°€ê¸° ë•Œë¬¸ì—
indexê°€ ë§ì§€ ì•Šì•„ì„œ ì œëŒ€ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ì˜€ë‹¤.   

ì •ê·œì‹ì„ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ì˜ ì´ë¦„ì„ ì œëŒ€ë¡œ ê°€ì ¸ì˜¤ë„ë¡ í•˜ì—¬ í•´ê²°í•˜ì˜€ë‹¤.

## ğŸ‘‰ì—…ë¬´ê´€ë¦¬ ì„œë¹„ìŠ¤   
### ë„ì»¤ë¥¼ í†µí•œ ë°°í¬
ë„ì»¤íŒŒì¼ ë¹Œë“œ : ë¹Œë“œí•œ ì‹œìŠ¤í…œì˜ CPU ì•„í‚¤í…ì²˜ê°€ ì´ìŠˆë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°°í¬ì‹œì—ëŠ” ì„œë²„ì—ì„œ ë„ì»¤íŒŒì¼ì„ ë¹Œë“œí•˜ë„ë¡ í•˜ì˜€ë‹¤. 
> [ì´ì œëŠ” ê°œë°œìë„ CPU ì•„í‚¤í…ì²˜ë¥¼ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤.](https://velog.io/@480/%EC%9D%B4%EC%A0%9C%EB%8A%94-%EA%B0%9C%EB%B0%9C%EC%9E%90%EB%8F%84-CPU-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%EB%A5%BC-%EA%B5%AC%EB%B6%84%ED%95%B4%EC%95%BC-%ED%95%A9%EB%8B%88%EB%8B%A4)   

### ë„ì»¤ íŒŒì¼ ë¹Œë“œ ê³¼ì •
1. Dockerfileë¡œ ë‚´ ì´ë¯¸ì§€ ë¹Œë“œ í™˜ê²½ êµ¬ì„±
2. docker-compose.yml ë¡œ ì•±ê³¼ DB ì»¨í…Œì´ë„ˆ êµ¬ì„± ë° ì—°ê²°

3. docker-compose up -d 
4. docker-compose logs 

5. mariaDB ì»¨í…Œì´ë„ˆì— DB ë³µì›

```
docker cp BSMG_2024-01-06.sql bsmgDB:/backup.sql
docker exec -it bsmgDB bash 
    
mariadb -u root -p0000 BSMG < backup.sql
```

### ë°°í¬ ì„œë²„ ì„¤ì •
1. í¬íŠ¸ ì—´ê¸°
2. ë°°í¬ ì„œë²„ì—ì„œ git clone
3. docker ì„¤ì¹˜í•˜ê¸° 
3-1. (Ubuntu)   
#### ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ 
    ```
    sudo apt update
    sudo apt upgrade -y
    ```   
#### ë„ì»¤ í•„ìš” íŒ¨í‚¤ì§€ ì„¤ì¹˜
    ```
    sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
    ```
#### ë„ì»¤ GPG í‚¤ ì¶”ê°€
    ```
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    ```
#### ë„ì»¤ APTì €ì¥ì†Œ ì¶”ê°€
    ```
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
#### ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ 
    ```
    sudo apt update
    ```
#### ë„ì»¤ ì„¤ì¹˜   
    ```
    sudo apt install -y docker-ce docker-ce-cli containerd.io
    ```
#### ë„ì»¤ ì„œë¹„ìŠ¤ ì‹œì‘ ë° ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰
    ```
    sudo systemctl start docker
    sudo systemctl enable docker
    ```

3-2. Rocky linux8 Docker ì„¤ì¹˜   
> <https://xshine.tistory.com/342 [ë©”ëª¨í•˜ëŠ”ìŠµê´€:í‹°ìŠ¤í† ë¦¬]>   
    ```
    sudo yum install -y yum-utils
    ```
#### Docker repository ì¶”ê°€
    sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

#### Docker Engine ì„¤ì¹˜
    sudo yum install docker-ce docker-ce-cli containerd.io
#### Docker ì‹¤í–‰ 
    sudo systemctl start docker

<br>   

### **ë°°í¬ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ë¹Œë“œ**      

#### webServer build      
```
docker build -t web . #bsmgRefactoringì—ì„œ
docker compose up --build -d #ê¸°ì¡´ ì´ë¯¸ì§€ì—ì„œ ë³€ê²½ì ë§Œ ë¹Œë“œ
docker compose ps 
docker compose down ë“± composeë¡œ í•œë²ˆì— ì œì–´ ê°€ëŠ¥
```

### ğŸ˜ƒ ì„¤ì • ì™„ë£Œ
ì´í›„ì—” docker composeë¥¼ í†µí•´ì„œ ì„œë¹„ìŠ¤ë¥¼ ê´€ë¦¬í•˜ë©´ ëœë‹¤.