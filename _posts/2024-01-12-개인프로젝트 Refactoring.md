---
title: ğŸ“†ê°œì¸í”„ë¡œì íŠ¸ Refactoring
date : 2024-01-12 23:00
category : [Study, Projects]
tags : [golang, echo, refactoring, architecture, docker, CI/CD]
---

ì˜ˆì „ì— **`ì—…ë¬´ë³´ê³  ê´€ë¦¬ (BSMG)`**ë¼ëŠ” í† ì´í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í–ˆì—ˆë‹¤.  
golangê³¼ ì¹œí•´ì§€ê¸° ìœ„í•´ ì§„í–‰í–ˆë˜ ì‘ì—…ë¬¼ì´ì—ˆëŠ”ë°, ë‹¤ì‹œ ë³´ë‹ˆ ë„ˆë¬´ ì¤‘êµ¬ë‚œë°©ì´ë¼ ì´ì°¸ì— ê³µë¶€í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ Refactoringì„ í•´ë³´ê³ ì í–ˆë‹¤.

## **ğŸ’¡ ë³€ê²½ì **
### ì½”ë“œì˜ ëª¨ë“ˆí™”
- ì´ì „ ì½”ë“œëŠ” handlerì—ì„œ DBì— ì¿¼ë¦¬ ì „ë‹¬ ì½”ë“œê¹Œì§€ í•œ ê³³ì— ëª°ë¹µí–ˆì—ˆë‹¤.
> ì´ì „ ì½”ë“œ

``` go
// ì£¼ê°„ ì—…ë¬´ë³´ê³  ì¹´í…Œê³ ë¦¬ setting
func setWeekRptCategoryRequest(writer http.ResponseWriter, request *http.Request) *WebErrorResult {
	var err error

	// ë¶€ì„œ ê°œìˆ˜ ì„¸ê¸°
	queryString := "SELECT COUNT(*) FROM bsmgPart"
	var count int
	_ = db.QueryRow(queryString).Scan(&count)

	var result BsmgTreeResult
	result.Result.ResultCode = 1
	if count > 0 {
		result.PartTreeList = make([]*PartTree, count)
	}

	queryString = "SELECT part_idx,part_name FROM bsmgPart WHERE part_idx != 0" // ê´€ë¦¬ìëŠ” ì œì™¸
	rows, err := db.Query(queryString)
	if err != nil {
		fmt.Println("ì¿¼ë¦¬ë¬¸ ì˜¤ë¥˜", err)
		return &WebErrorResult{http.StatusOK, ErrorInvalidParameter}
	}
	defer rows.Close()

	var ii = 0
	for rows.Next() {
		var part_idx sql.NullInt32
		var part_category sql.NullString

		err := rows.Scan(&part_idx, &part_category)
		if err != nil {
			fmt.Println("ì„œë²„ ë³€ìˆ˜ DB ë°ì´í„° í• ë‹¹ ì˜¤ë¥˜", err)
			return &WebErrorResult{http.StatusOK, ErrorInvalidParameter}
		}
		result.PartTreeList[ii] = &PartTree{}
		result.PartTreeList[ii].Label = part_category.String
		result.PartTreeList[ii].Value = "1-" + strconv.Itoa(int(part_idx.Int32))
		result.PartTreeList[ii].Parent = "1"
		ii++
	}
	result.PartTreeList[ii] = &PartTree{}
	result.PartTreeList[ii].Label = "ë¶€ì„œë³„ ì£¼ê°„ ì—…ë¬´ë³´ê³ "
	result.PartTreeList[ii].Value = "1"
	result.PartTreeList[ii].Parent = "0"

	result.Result.ResultCode = 0
	responseMsg, _ := json.Marshal(result)
	sendResultEx(writer, request, http.StatusOK, responseMsg)
	return nil
}
```   
<hr>
ê¸°ì¡´ì˜ ì´ëŸ° ì½”ë“œë“¤ì„ ëª¨ë‘ ëª©ì ì— ë§ê²Œ ë‚˜ëˆ„ì–´ ëª¨ë“ˆì—ì„œ ë¶ˆëŸ¬ì˜¤ë„ë¡ ë³€ê²½í•˜ì˜€ë‹¤.   
> ë³€ê²½í•œ ì½”ë“œ

``` go
// ì£¼ê°„ ì—…ë¬´ë³´ê³  ì¹´í…Œê³ ë¦¬ ì •ë³´
func getPartTree(c echo.Context) (err error) {
	log.Println("getPartTree")

	var apiResponse define.BsmgTreeResult

	server, _ := c.Get("Server").(*server.ServerProcessor)
	server.Mutex.Lock()
	defer server.Mutex.Unlock()

	apiResponse.PartTreeList, err = server.DBManager.DBGorm.MakePartTree()
	if err != nil {
		log.Printf("%v \n", err)
		apiResponse.Result.ResultCode = define.ErrorDataBase
		return c.JSON(http.StatusOK, apiResponse)
	}

	apiResponse.Result.ResultCode = define.Success
	return c.JSON(http.StatusOK, apiResponse)
}
```   
> ëª¨ë“ˆí™”ì— ëŒ€í•´ ê°€ìŠ´ê¹Šì´ ì´í•´í•˜ì§€ ëª»í–ˆë˜ ê²ƒ ê°™ë‹¤. ë¶„ë¦¬ì‹œí‚¤ëŠë¼ ì •ë§ í˜ë“¤ì—ˆë‹¤.   

<br>

### í”„ë ˆì„ì›Œí¬ ì‚¬ìš©
- í”„ë ˆì„ì›Œí¬ë¥¼ ë¬´ì¡°ê±´ì ìœ¼ë¡œ ì¨ì•¼í•˜ëŠ” ê±´ ì•„ë‹ˆì§€ë§Œ, ê°œë°œì— í•„ìš”í•œ ë§ì€ ê¸°ëŠ¥ì„ í¸í•˜ê²Œ ì œê³µí•˜ëŠ” ì¸¡ë©´ê³¼ ì½”ë“œì˜ ê°„ê²°ì„±ì„ ìœ„í•´ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ì—ˆë‹¤.  

### Mutexë¥¼ í†µí•œ ìƒí˜¸ ë°°ì œ
- ë³„ê±°ì•„ë‹Œ ì½”ë“œë¡œ ì¸í•´ ë°ë“œë½ì˜ ë¬´ì„œì›€ì„ ì‹¤ì œë¡œ ê²ªì–´ë´¤ë‹¤. MutexëŠ” ì¡°ì‹¬íˆ ë‹¤ë¤„ì•¼ê² ë‹¤ëŠ” êµí›ˆì„ ì–»ì—ˆë‹¤.   

### JWT ì‚¬ìš©
- ì„¸ì…˜ì´ ì•„ë‹Œ JWTë¥¼ ì‚¬ìš©í•´ë³´ê³ ì‹¶ì—ˆë‹¤.   
- í† í°ì„ í•˜ë‚˜ë§Œ ë§Œë“¤ë‹¤ê°€, AccessToken, RefreshToken 2ê°œì˜ í† í°ì„ ë§Œë“œëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì˜€ë‹¤.   

### Nginx ì‚¬ìš©
- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ìœ„í•´ Nginxë¥¼ ê±°ì³ì„œ APIì„œë²„ë¡œ ê°€ë„ë¡ í•˜ì˜€ë‹¤.

### ë„ì»¤ë¥¼ í†µí•œ ì»¨í…Œì´ë„ˆë¡œ ë°°í¬
- ì„œë¹„ìŠ¤ë¥¼ ì‹¤ì œë¡œ ë„ì»¤ ì´ë¯¸ì§€í™”í•˜ì—¬ ë°°í¬ê¹Œì§€ í•´ë³´ëŠ” ê³¼ì •ì„ í•˜ê³  ì‹¶ì—ˆë‹¤.  
- ì´ ê³¼ì •ì—ì„œ ë¬´ìˆ˜í•œ ì‹œí–‰ì°©ì˜¤ë¥¼ ê²ªê²Œ ë˜ì—ˆë‹¤.. ë‹¨ìˆœ ë¡œì»¬ ê°œë°œí™˜ê²½ì—ì„œ ì‹¤í–‰, ë¡œì»¬ì—ì„œ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰, í´ë¼ìš°ë“œ ì„œë²„ì— ë°°í¬ê¹Œì§€ ê³ ë ¤í•´ì•¼ í•  ì ì´ ë§ì•„ ê³µë¶€ë¥¼ ë§ì´ í•´ì•¼í–ˆë‹¤.
> https://velog.io/@480/%EC%9D%B4%EC%A0%9C%EB%8A%94-%EA%B0%9C%EB%B0%9C%EC%9E%90%EB%8F%84-CPU-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%EB%A5%BC-%EA%B5%AC%EB%B6%84%ED%95%B4%EC%95%BC-%ED%95%A9%EB%8B%88%EB%8B%A4


## **ğŸ˜­ ì•„ì‰½ê³  ë¯¸í¡í•œ ì **   
### TDD
- í…ŒìŠ¤íŠ¸ ê¸°ë°˜ ê°œë°œì— ëŒ€í•´ ì•Œì•„ë³´ê¸°ë„ í–ˆê³ , ì´ë²ˆì—ëŠ” ê·¸ëŸ°ì‹ìœ¼ë¡œ í•´ë´ì•¼ì§€ í–ˆì§€ë§Œ, ë§‰ìƒ ì‘ì„±ì´ ì‰½ì§€ ì•Šì•„ ëˆ„ë½í•˜ê¸° ì¼ì‘¤ì˜€ë‹¤.   
- ë˜í•œ, TDDëŠ” ì•„ë¬´ê²ƒë„ ì•ˆëœ ì¼€ì´ìŠ¤ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¨ê³„ë¥¼ ë°Ÿì•„ê°€ë©° ê°œë°œí•´ ë‚˜ê°€ì•¼í•˜ëŠ”ë°, ìŠµê´€ì ìœ¼ë¡œ ê¸°ëŠ¥ ê°œë°œ -> í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±ì´ ë˜ì—ˆë‹¤. 
- **Github Actions**ë¥¼ í†µí•œ WorkFlowë¬¸ì„œë¥¼ ì‘ì„±í•˜ë©°, ì´ë¶€ë¶„ì´ ì°¸ ì•„ì‰¬ì› ë‹¤.   
í…ŒìŠ¤íŠ¸ ì½”ë“œë§Œ ì˜ ì§œë†¨ìœ¼ë©´, ë¹Œë“œ ì˜¤ë¥˜, ê¸°ëŠ¥ ì˜¤ë¥˜ë¥¼ ìë™ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆì—ˆì„ í…ë°..    

### ìŠ¤ë ˆë“œì˜ ì‚¬ìš©   
- goë£¨í‹´ê³¼ ì±„ë„ë§ì„ í†µí•´ì„œ goë§Œì˜ ì¥ì ì„ ê°•í™”í•´ë³´ë ¤ í–ˆë‹¤.
í•˜ì§€ë§Œ ê¸°ì¡´ ê¸°ëŠ¥ì—ì„  `ì£¼ê°„ ì—…ë¬´ë³´ê³  ìë™ ìƒì„±` ë§ê³ ëŠ” í• ë§Œí•œ ê¸°ëŠ¥ì´ ì—†ì—ˆë‹¤.  
DBì‘ì—…ì´ ê·¸ë‚˜ë§ˆ ê³ ë ¤ëŒ€ìƒì´ì—ˆëŠ”ë°, DBì ‘ê·¼ ì‹œ Mutexë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒí˜¸ë°°ì œë¥¼ í•˜ë‹ˆ ë³‘ë ¬ì²˜ë¦¬ì˜ ì˜ë¯¸ê°€ ì—†ë‹¤ê³  íŒë‹¨í–ˆë‹¤.   
- ì¶”í›„ ë‚˜ í˜¹ì€ ì§€ì¸ì˜ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ ì—°ë™ì‹œí‚¨ë‹¤ë©´, ì‚¬ìš©ì ë™ê¸°í™” ë“±ì—ì„œ ì‚¬ìš©í•  ì—¬ì§€ê°€ ìˆì„ ë“¯í•˜ë‹¤.   

### ì™¸ë¶€ API ì—°ë™   
- ë„¤ì´ë²„ ì›ìŠ¤ë¼ë˜ê°€ ì—¬ëŸ¬ ì˜¤í”ˆ APIë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ëŠ¥ ì¶”ê°€ë„ ê³ ë ¤í–ˆì—ˆëŠ”ë°, ë§ˆìŒ ì† ìš°ì„ ìˆœìœ„ì—ì„œ ë§ì´ ë°€ë¦¬ë‹¤ê°€ ê²°êµ­ ì•ˆí•˜ê²Œ ë˜ì—ˆë‹¤.   

### ìºì‹œ ì„œë²„
- Redisë¥¼ í†µí•œ ìºì‹œ ì„œë²„ë¥¼ ë‘ì–´ ë¶ˆí•„ìš”í•œ DB íŠ¸ë˜í”½ ë¹„ìš©ì„ ë‘¬ë³´ê³ ì‹¶ì—ˆì§€ë§Œ, ì•„ì§ ë¯¸ì •ì´ë‹¤...   

### ë””ìì¸ íŒ¨í„´ ì ìš©
- í”„ë¡œì íŠ¸ì—ì„  **`Adaptor`**, **`Singleton`** íŒ¨í„´ ì •ë„ë¥¼ ì¨ë³¸ ê²ƒ ê°™ë‹¤.   
- ì—¬ëŸ¬ ë””ìì¸íŒ¨í„´ì„ ë“¤ì–´ë´¤ë‹¤ê³  ë°”ë¡œë°”ë¡œ ì ìš©ì´ ë  ë¦¬ê°€ ì—†ë‹¤..
ê¸°ëŠ¥ì ì¸ ì¶”ê°€ëŠ” í˜ë“¤ë”ë¼ë„ ë””ìì¸íŒ¨í„´ ê³µë¶€ëŠ” ê³„ì†í•˜ë©° ì½”ë“œë¥¼ ë³€ê²½í•´ë‚˜ê°€ê³ ì í•œë‹¤.   

### API ë¬¸ì„œ ì œì‘
- Swaggerë¥¼ í†µí•´ì„œ ì§„í–‰í•˜ë ¤ í–ˆëŠ”ë° Scalar ì–˜ê¸°ë„ ë§ì´ ë³´ì´ê³  ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ê³ ë¯¼ì¤‘ì´ë‹¤.   

### ì¸ê°€
- ì¸ê°€ëŠ” í˜„ì¬ í”„ë¡ íŠ¸ë‹¨ì—ì„œë§Œ êµ¬í˜„ë˜ì–´ìˆë‹¤.   
ê·¸ê²ƒë„ ë°˜ìª½ì§œë¦¬ì¸ ê²ƒì´, íƒ€ì¸ì˜ ë³´ê³ ì„œë¥¼ ë§ˆêµ¬ í›”ì³ë³¼ ìˆ˜ ìˆë‹¤.   
- JWTëŠ” ì„œë²„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ ì•„ë‹Œì§€ë§Œ íŒë³„í•œë‹¤. 
- user ë„ë©”ì¸, report ë„ë©”ì¸ì— ì ‘ê·¼í•  ë•Œ í† í°ì„ í†µí•œ ì¸ê°€ë¥¼ ì„œë²„ì—ì„œë„ êµ¬í˜„í•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.   

## **ğŸ’¡ í›„ê¸°**
í”„ë¡œì íŠ¸ ì£¼ì œì˜ ë§¤ë ¥ë³´ë‹¤ëŠ” ê³µë¶€ì˜ ëŠë‚Œìœ¼ë¡œ Refactoringì„ ì§„í–‰í–ˆê³ , ì‹¤ì œë¡œ ë§ì´ ê³µë¶€ëœ ê²ƒ ê°™ë‹¤.   
ì—­ì‹œ ë¨¸ë¦¬ë¡œë§Œ ë“£ê³  ì•„ëŠ” ê²ƒë³´ë‹¤ ì‹¤ì œë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì´ í›¨ì”¬ ê³µë¶€ê°€ ì˜ ë˜ëŠ” ê²ƒ ê°™ë‹¤.  
> í˜ë“¤ì—ˆë˜ ì !!   
1.ë ˆê±°ì‹œë¥¼ ì œê±°í•˜ë©° ê¸°ì¡´ ê¸°ëŠ¥ì„ ì‚´ë¦¬ëŠ” ê²ƒ   
2.ì§€ì‹ì˜ ì‹¤ì²œ (ê¸°ë²•, ê¸°ìˆ  ë“±ë“±..)   
3.ëª¨ë¥´ëŠ” ê²Œ ë„ˆë¬´ ë§ì•„ í•˜ë‚˜í•˜ë‚˜ ê³µë¶€í•˜ë˜ ê²ƒ

ë‹¤ë¥¸ í† ì´ í”„ë¡œì íŠ¸ë„ í•´ë³´ê³  ì‹¶ì–´ì„œ ë‹¹ë¶„ê°„ì€ Refactoringì„ ì¤‘ë‹¨í•˜ë ¤ í•œë‹¤.   
ë” ì„±ì¥í•˜ì—¬ ë©‹ì§„ ë°©í–¥ìœ¼ë¡œ ë°œì „ì‹œí‚¤ê³  ì‹¶ë‹¤!!


##### TODO ê³µë¶€í•œ ê²ƒ í¬ìŠ¤íŒ… 
1. ë ˆì´ì–´ ì•„í‚¤í…ì²˜
2. Echo í”„ë ˆì„ì›Œí¬ ì„ íƒ ì´ìœ  ë° ê°„ë‹¨ ì‚¬ìš©ë²•
3. JWT 
4. ë””ìì¸ íŒ¨í„´ ê´€ë ¨
5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° compose ê´€ë ¨ ë° CPU ì•„í‚¤í…ì²˜ ë“± ì£¼ì˜ì 
6. ê¹ƒí—ˆë¸Œ ì•¡ì…˜ 
7. blue/green ë¬´ì¤‘ë‹¨ ë°°í¬
8. ìºì‹œ ì„œë²„